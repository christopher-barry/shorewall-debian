#!/usr/bin/make -f
# -*- makefile -*-

# Uncomment this to turn on verbose mode.
#export DH_VERBOSE=1

# shorewall version
export VFULL=`grep "^VERSION=" install.sh | head -n 1 | cut -f 2 -d "="`
export V=`grep "^VERSION=" install.sh | head -n 1 | cut -f 2 -d "=" | cut -f 1-3 -d "."`
VMAJOR:=$(shell echo $(V) |cut -f 1 -d .)
VMINOR:=$(shell echo $(V) |cut -f 2 -d .)
VPATCH:=$(shell echo $(V) |cut -f 3 -d .)
NEXTPATCH:=$(shell expr $(VPATCH) + 1 2>/dev/null || expr `echo $(VPATCH) | cut -f 1 -d - ` + 1)

SRWL=$(CURDIR)/debian/shorewall

%:
	dh $@ 

debian/po/templates.pot: debian/shorewall.templates
	@debconf-updatepo

override_dh_auto_configure:
	true

override_dh_auto_build:
	true

override_dh_auto_clean:
	rm -rf $(SRWL)

override_dh_install:
	echo 'shorewall:current=$(VMAJOR).$(VMINOR).$(VPATCH)~' \
		>> debian/shorewall.substvars
	echo 'shorewall:next=$(VMAJOR).$(VMINOR).$(NEXTPATCH)~' \
		>> debian/shorewall.substvars
	DESTDIR=$(SRWL) BUILD=debian HOST=debian $(CURDIR)/install.sh
	find $(SRWL) -type d -empty -delete
# 	set version number
	echo $(VFULL) > $(SRWL)/usr/share/shorewall/version

override_dh_fixperms:
	dh_fixperms -Xetc/shorewall -Xvar/lib/shorewall
# 	Temporary zones are only available to root
#	chmod 750 $(SRWL)/var/lib/shorewall
# 	As well as configuration files
	chmod 755 $(SRWL)/etc/shorewall
	chmod 640 $(SRWL)/etc/shorewall/*
	chmod 644 $(SRWL)/etc/shorewall/shorewall.conf
	chmod 644 $(SRWL)/etc/shorewall/Makefile
#  global configuration has to be fully readable
	chmod 644 $(SRWL)/usr/share/shorewall/*
#  must be executable
	chmod 755 $(SRWL)/usr/share/shorewall/getparams
	chmod 755 $(SRWL)/usr/share/shorewall/compiler.pl
	chmod 755 $(SRWL)/usr/share/shorewall/Shorewall

override_dh_compress:
	dh_compress -Xusr/share/doc/shorewall/default-config

override_dh_installinit:
	dh_installinit --onlyscripts --no-start -u"start 40 S . stop 89 0 6 ."

override_dh_installman:
	dh_installman manpages/*

