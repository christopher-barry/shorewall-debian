'\" t
.\"     Title: shorewall6-tcrules
.\"    Author: [FIXME: author] [see http://docbook.sf.net/el/author]
.\" Generator: DocBook XSL Stylesheets v1.75.2 <http://docbook.sf.net/>
.\"      Date: 06/17/2010
.\"    Manual: [FIXME: manual]
.\"    Source: [FIXME: source]
.\"  Language: English
.\"
.TH "SHOREWALL6\-TCRULES" "5" "06/17/2010" "[FIXME: source]" "[FIXME: manual]"
.\" -----------------------------------------------------------------
.\" * Define some portability stuff
.\" -----------------------------------------------------------------
.\" ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
.\" http://bugs.debian.org/507673
.\" http://lists.gnu.org/archive/html/groff/2009-02/msg00013.html
.\" ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
.ie \n(.g .ds Aq \(aq
.el       .ds Aq '
.\" -----------------------------------------------------------------
.\" * set default formatting
.\" -----------------------------------------------------------------
.\" disable hyphenation
.nh
.\" disable justification (adjust text to left margin only)
.ad l
.\" -----------------------------------------------------------------
.\" * MAIN CONTENT STARTS HERE *
.\" -----------------------------------------------------------------
.SH "NAME"
tcrules \- Shorewall6 Packet Marking rules file
.SH "SYNOPSIS"
.HP \w'\fB/etc/shorewall6/tcrules\fR\ 'u
\fB/etc/shorewall6/tcrules\fR
.SH "DESCRIPTION"
.PP
Entries in this file cause packets to be marked as a means of classifying them for traffic control or policy routing\&.
.if n \{\
.sp
.\}
.RS 4
.it 1 an-trap
.nr an-no-space-flag 1
.nr an-break-flag 1
.br
.ps +1
\fBImportant\fR
.ps -1
.br
.PP
Unlike rules in the
\m[blue]\fBshorewall6\-rules\fR\m[]\&\s-2\u[1]\d\s+2(5) file, evaluation of rules in this file will continue after a match\&. So the final mark for each packet will be the one assigned by the LAST tcrule that matches\&.
.PP
If you use multiple internet providers with the \*(Aqtrack\*(Aq option, in /etc/shorewall6/providers be sure to read the restrictions at
\m[blue]\fBhttp://shorewall\&.net/MultiISP\&.html\fR\m[]\&.
.sp .5v
.RE
.PP
The columns in the file are as follows\&.
.PP
\fBMARK/CLASSIFY\fR \- {\fIvalue\fR|\fImajor\fR\fB:\fR\fIminor\fR|\fBRESTORE\fR[\fB/\fR\fImask\fR]|\fBSAVE\fR[\fB/\fR\fImask\fR]|\fBCONTINUE\fR|\fBCOMMENT\fR}[\fB:\fR{\fBC\fR|\fBF\fR|\fBP\fR|\fBT\fR|\fBCF\fR|\fBCP\fR|\fBCT\fR}]
.RS 4
May assume one of the following values\&.
.sp
.RS 4
.ie n \{\
\h'-04' 1.\h'+01'\c
.\}
.el \{\
.sp -1
.IP "  1." 4.2
.\}
A mark
\fIvalue\fR
which is an integer in the range 1\-255\&.
.sp
Normally will set the mark value\&. If preceded by a vertical bar ("|"), the mark value will be logically ORed with the current mark value to produce a new mark value\&. If preceded by an ampersand ("&"), will be logically ANDed with the current mark value to produce a new mark value\&.
.sp
Both "|" and "&" require Extended MARK Target support in your kernel and ip6tables; neither may be used with connection marks (see below)\&.
.sp
May optionally be followed by
\fB:P\fR,
\fB:F\fR
or
\fB:T\fR
where\fB :P\fR
indicates that marking should occur in the PREROUTING chain,
\fB:F\fR
indicates that marking should occur in the FORWARD chain and
\fB:T\fR
indicates that marking should occur in the POSTROUTING chain\&. If neither
\fB:P\fR,
\fB:F\fR
nor
\fB:T\fR
follow the mark value then the chain is determined as follows:
.sp
\- If the SOURCE is
\fB$FW\fR[\fB:\fR\fIaddress\-or\-range\fR[,\fIaddress\-or\-range\fR]\&.\&.\&.], then the rule is inserted into the OUTPUT chain\&. The behavior changed in Shorewall6\-perl 4\&.1\&. Only high mark values may be assigned in this case\&. Packet marking rules for traffic shaping of packets originating on the firewall must be coded in the POSTROUTING chain (see below)\&.
.sp
\- Otherwise, the chain is determined by the setting of MARK_IN_FORWARD_CHAIN in
\m[blue]\fBshorewall6\&.conf\fR\m[]\&\s-2\u[2]\d\s+2(5)\&.
.sp
If your kernel and ip6tables include CONNMARK support then you can also mark the connection rather than the packet\&.
.sp
The mark value may be optionally followed by "/" and a mask value (used to determine those bits of the connection mark to actually be set)\&. The mark and optional mask are then followed by one of:+
.PP
\fBC\fR
.RS 4
Mark the connection in the chain determined by the setting of MARK_IN_FORWARD_CHAIN
.RE
.PP
\fBCF\fR
.RS 4
Mark the connection in the FORWARD chain
.RE
.PP
\fBCP\fR
.RS 4
Mark the connection in the PREROUTING chain\&.
.RE
.PP
CT
.RS 4
Mark the connecdtion in the POSTROUTING chain
.RE
.sp
\fBSpecial considerations for If HIGH_ROUTE_MARKS=Yes in \fR\fB\m[blue]\fBshorewall6\&.conf\fR\m[]\&\s-2\u[2]\d\s+2\fR\fB(5\fR)\&.
.sp
If HIGH_ROUTE_MARKS=Yes, then you may also specify a value in the range 0x0100\-0xFF00 with the low\-order byte being zero\&. Such values may only be used in the PREROUTING chain (value followed by
\fB:P\fR
or you have set MARK_IN_FORWARD_CHAIN=No in
\m[blue]\fBshorewall6\&.conf\fR\m[]\&\s-2\u[2]\d\s+2(5) and have not followed the value with
\fB:F\fR) or the OUTPUT chain (SOURCE is
\fB$FW\fR)\&. With HIGH_ROUTE_MARKS=Yes, non\-zero mark values less that 256 are not permitted\&. Shorewall6 prohibits non\-zero mark values less that 256 in the OUTPUT chain when HIGH_ROUTE_MARKS=Yes\&. While earlier versions allow such values in the OUTPUT chain, it is strongly recommended that with HIGH_ROUTE_MARKS=Yes, you use the POSTROUTING chain to apply traffic shaping marks/classification\&.
.RE
.sp
.RS 4
.ie n \{\
\h'-04' 2.\h'+01'\c
.\}
.el \{\
.sp -1
.IP "  2." 4.2
.\}
A classification Id (classid) of the form
\fImajor\fR:\fIminor\fR
where
\fImajor\fR
and
\fIminor\fR
are integers\&. Corresponds to the \*(Aqclass\*(Aq specification in these traffic shaping modules:
.sp
.if n \{\
.RS 4
.\}
.nf
       atm
       cbq
       dsmark
       pfifo_fast
       htb
       prio
.fi
.if n \{\
.RE
.\}
.sp
Classification occurs in the POSTROUTING chain except when the
\fBSOURCE\fR
is
\fB$FW\fR[:\fIaddress\fR] in which case classification occurs in the OUTPUT chain\&.
.sp
When using Shorewall6\*(Aqs built\-in traffic shaping tool, the
\fImajor\fR
class is the device number (the first device in
\m[blue]\fBshorewall6\-tcdevices\fR\m[]\&\s-2\u[3]\d\s+2(5) is major class 1, the second device is major class 2, and so on) and the
\fIminor\fR
class is the class\*(Aqs MARK value in
\m[blue]\fBshorewall6\-tcclasses\fR\m[]\&\s-2\u[4]\d\s+2(5) preceded by the number 1 (MARK 1 corresponds to minor class 11, MARK 5 corresponds to minor class 15, MARK 22 corresponds to minor class 122, etc\&.)\&.
.RE
.sp
.RS 4
.ie n \{\
\h'-04' 3.\h'+01'\c
.\}
.el \{\
.sp -1
.IP "  3." 4.2
.\}
\fBRESTORE\fR[/\fImask\fR] \-\- restore the packet\*(Aqs mark from the connection\*(Aqs mark using the supplied mask if any\&. Your kernel and ip6tables must include CONNMARK support\&.
.sp
As in 1) above, may be followed by
\fB:P\fR
or
\fB:F\fR
.RE
.sp
.RS 4
.ie n \{\
\h'-04' 4.\h'+01'\c
.\}
.el \{\
.sp -1
.IP "  4." 4.2
.\}
\fBSAVE\fR[/\fImask\fR] \-\- save the packet\*(Aqs mark to the connection\*(Aqs mark using the supplied mask if any\&. Your kernel and ip6tables must include CONNMARK support\&.
.sp
As in 1) above, may be followed by
\fB:P\fR
or
\fB:F\fR
.RE
.sp
.RS 4
.ie n \{\
\h'-04' 5.\h'+01'\c
.\}
.el \{\
.sp -1
.IP "  5." 4.2
.\}
\fBCONTINUE\fR
Don\*(Aqt process any more marking rules in the table\&.
.sp
As in 1) above, may be followed by
\fB:P\fR
or
\fB:F\fR\&. Currently, CONTINUE may not be used with
\fIexclusion\fR
(see the SOURCE and DEST columns below); that restriction will be removed when ip6tables/Netfilter provides the necessary support\&.
.RE
.sp
.RS 4
.ie n \{\
\h'-04' 6.\h'+01'\c
.\}
.el \{\
.sp -1
.IP "  6." 4.2
.\}
\fBSAME\fR
(Added in Shorewall 4\&.3\&.5) \-\- Some websites run applications that require multiple connections from a client browser\&. Where multiple \*(Aqbalanced\*(Aq providers are configured, this can lead to problems when some of the connections are routed through one provider and some through another\&. The SAME target allows you to work around that problem\&. SAME may be used in the PREROUTING and OUTPUT chains\&. When used in PREROUTING, it causes matching connections from an individual local system to all use the same provider\&. For example:
.sp
.if n \{\
.RS 4
.\}
.nf
#MARK/            SOURCE         DEST         PROTO      DEST
#CLASSIFY                                                PORT(S)
SAME:P            192\&.168\&.1\&.0/24 0\&.0\&.0\&.0/0    tcp        80,443
.fi
.if n \{\
.RE
.\}
.sp
If a host in 192\&.168\&.1\&.0/24 attempts a connection on TCP port 80 or 443 and it has sent a packet on either of those ports in the last five minutes then the new connection will use the same provider as the connection over which that last packet was sent\&.
.sp
When used in the OUTPUT chain, it causes all matching connections to an individual remote system to all use the same provider\&. For example:
.sp
.if n \{\
.RS 4
.\}
.nf
#MARK/            SOURCE         DEST         PROTO      DEST
#CLASSIFY                                                PORT(S)
SAME              $FW            0\&.0\&.0\&.0/0    tcp        80,443
.fi
.if n \{\
.RE
.\}
.sp
If the firewall attempts a connection on TCP port 80 or 443 and it has sent a packet on either of those ports in the last five minutes to the same remote system then the new connection will use the same provider as the connection over which that last packet was sent\&.
.RE
.sp
.RS 4
.ie n \{\
\h'-04' 7.\h'+01'\c
.\}
.el \{\
.sp -1
.IP "  7." 4.2
.\}
\fBCOMMENT\fR
\-\- the rest of the line will be attached as a comment to the Netfilter rule(s) generated by the following entries\&. The comment will appear delimited by "/* \&.\&.\&. */" in the output of
\fBshorewall6 show mangle\fR
.sp
To stop the comment from being attached to further rules, simply include COMMENT on a line by itself\&.
.RE
.RE
.PP
\fBSOURCE\fR \- {\fB\-\fR|{\fIinterface\fR|\fB$FW\fR}|[{\fIinterface\fR|\fB$FW\fR}:]<\fIaddress\-or\-range\fR[\fB,\fR\fIaddress\-or\-range\fR]\&.\&.\&.}[\fIexclusion\fR]>
.RS 4
Source of the packet\&. A comma\-separated list of interface names, IP addresses, MAC addresses and/or subnets for packets being routed through a common path\&. List elements may also consist of an interface name followed by ":" and an address (e\&.g\&., eth1:<2002:ce7c:92b4::/48>)\&. For example, all packets for connections masqueraded to eth0 from other interfaces can be matched in a single rule with several alternative SOURCE criteria\&. However, a connection whose packets gets to eth0 in a different way, e\&.g\&., direct from the firewall itself, needs a different rule\&.
.sp
Accordingly, use $\fBFW\fR
in its own separate rule for packets originating on the firewall\&. In such a rule, the MARK column may NOT specify either
\fB:P\fR
or
\fB:F\fR
because marking for firewall\-originated packets always occurs in the OUTPUT chain\&.
.sp
MAC addresses must be prefixed with "~" and use "\-" as a separator\&.
.sp
Example: ~00\-A0\-C9\-15\-39\-78
.sp
When an interface is not specified, the angled brackets (\*(Aq<\*(Aq and \*(Aq>\*(Aq) surrounding the address(es) may be omitted\&.
.sp
You may exclude certain hosts from the set already defined through use of an
\fIexclusion\fR
(see
\m[blue]\fBshorewall6\-exclusion\fR\m[]\&\s-2\u[5]\d\s+2(5))\&.
.RE
.PP
\fBDEST\fR \- {\fB\-\fR|{\fIinterface\fR|[\fIinterface\fR:]<\fIaddress\-or\-range\fR[\fB,\fR\fIaddress\-or\-range\fR]\&.\&.\&.}[\fIexclusion\fR]>
.RS 4
Destination of the packet\&. Comma separated list of IP addresses and/or subnets\&. If your kernel and ip6tables include iprange match support, IP address ranges are also allowed\&. List elements may also consist of an interface name followed by ":" and an address (e\&.g\&., eth1:<2002:ce7c:92b4::/48>)\&. If the
\fBMARK\fR
column specificies a classification of the form
\fImajor\fR:\fIminor\fR
then this column may also contain an interface name\&.
.sp
When an interface is not specified, the angled brackets (\*(Aq<\*(Aq and \*(Aq>\*(Aq) surrounding the address(es) may be omitted\&.
.sp
You may exclude certain hosts from the set already defined through use of an
\fIexclusion\fR
(see
\m[blue]\fBshorewall6\-exclusion\fR\m[]\&\s-2\u[5]\d\s+2(5))\&.
.RE
.PP
\fBPROTO\fR \- {\fB\-\fR|\fBtcp:syn\fR|\fBipp2p\fR|\fBipp2p:udp\fR|\fBipp2p:all\fR|\fIprotocol\-number\fR|\fIprotocol\-name\fR|\fBall}\fR
.RS 4
Protocol \-
\fBipp2p\fR
requires ipp2p match support in your kernel and ip6tables\&.
.RE
.PP
\fBPORT(S)\fR (Optional) \- [\fB\-\fR|\fIport\-name\-number\-or\-range\fR[\fB,\fR\fIport\-name\-number\-or\-range\fR]\&.\&.\&.]
.RS 4
Destination Ports\&. A comma\-separated list of Port names (from services(5)),
\fIport number\fRs or
\fIport range\fRs; if the protocol is
\fBicmp\fR, this column is interpreted as the destination icmp\-type(s)\&. ICMP types may be specified as a numeric type, a numberic type and code separated by a slash (e\&.g\&., 3/4), or a typename\&. See
\m[blue]\fBhttp://www\&.shorewall\&.net/configuration_file_basics\&.htm#ICMP\fR\m[]\&.
.sp
If the protocol is
\fBipp2p\fR, this column is interpreted as an ipp2p option without the leading "\-\-" (example
\fBbit\fR
for bit\-torrent)\&. If no PORT is given,
\fBipp2p\fR
is assumed\&.
.sp
This column is ignored if PROTOCOL = all but must be entered if any of the following field is supplied\&. In that case, it is suggested that this field contain "\-"
.RE
.PP
\fBSOURCE PORT(S)\fR (Optional) \- [\fB\-\fR|\fIport\-name\-number\-or\-range\fR[\fB,\fR\fIport\-name\-number\-or\-range\fR]\&.\&.\&.]
.RS 4
Source port(s)\&. If omitted, any source port is acceptable\&. Specified as a comma\-separated list of port names, port numbers or port ranges\&.
.RE
.PP
\fBUSER\fR (Optional) \- [\fB!\fR][\fIuser\-name\-or\-number\fR][\fB:\fR\fIgroup\-name\-or\-number\fR]
.RS 4
This column may only be non\-empty if the SOURCE is the firewall itself\&.
.sp
When this column is non\-empty, the rule applies only if the program generating the output is running under the effective
\fIuser\fR
and/or
\fIgroup\fR
specified (or is NOT running under that id if "!" is given)\&.
.sp
Examples:
.PP
joe
.RS 4
program must be run by joe
.RE
.PP
:kids
.RS 4
program must be run by a member of the \*(Aqkids\*(Aq group
.RE
.PP
!:kids
.RS 4
program must not be run by a member of the \*(Aqkids\*(Aq group
.RE
.RE
.PP
\fBTEST\fR \- [\fB!\fR]\fIvalue\fR[/\fImask\fR][\fB:C\fR]
.RS 4
Defines a test on the existing packet or connection mark\&. The rule will match only if the test returns true\&.
.sp
If you don\*(Aqt want to define a test but need to specify anything in the following columns, place a "\-" in this field\&.
.PP
!
.RS 4
Inverts the test (not equal)
.RE
.PP
\fIvalue\fR
.RS 4
Value of the packet or connection mark\&.
.RE
.PP
\fImask\fR
.RS 4
A mask to be applied to the mark before testing\&.
.RE
.PP
\fB:C\fR
.RS 4
Designates a connection mark\&. If omitted, the packet mark\*(Aqs value is tested\&.
.RE
.RE
.PP
\fBLENGTH\fR (Optional) \- [\fIlength\fR|[\fImin\fR]\fB:\fR[\fImax\fR]]
.RS 4
Packet Length\&. This field, if present allow you to match the length of a packet against a specific value or range of values\&. You must have ip6tables length support for this to work\&. A range is specified in the form
\fImin\fR:\fImax\fR
where either
\fImin\fR
or
\fImax\fR
(but not both) may be omitted\&. If
\fImin\fR
is omitted, then 0 is assumed; if
\fImax\fR
is omitted, than any packet that is
\fImin\fR
or longer will match\&.
.RE
.PP
\fBTOS\fR \- \fItos\fR
.RS 4
Type of service\&. Either a standard name, or a numeric value to match\&.
.sp
.if n \{\
.RS 4
.\}
.nf
         \fBMinimize\-Delay\fR (16)
         \fBMaximize\-Throughput\fR (8)
         \fBMaximize\-Reliability\fR (4)
         \fBMinimize\-Cost\fR (2)
         \fBNormal\-Service\fR (0)
.fi
.if n \{\
.RE
.\}
.RE
.PP
\fBCONNBYTES\fR \- [!]\fImin\fR:[\fImax\fR[:{\fBO\fR|\fBR\fR|\fBB\fR}[:{\fBB\fR|\fBP\fR|\fBA\fR}]]]
.RS 4
Connection Bytes; defines a byte or packet range that the connection must fall within in order for the rule to match\&.
.sp
A packet matches if the the packet/byte count is within the range defined by
\fImin\fR
and
\fImax\fR
(unless ! is given in which case, a packet matches if the packet/byte count is not within the range)\&.
\fImin\fR
is an integer which defines the beginning of the byte/packet range\&.
\fImax\fR
is an integer which defines the end of the byte/packet range; if omitted, only the beginning of the range is checked\&. The first letter gives the direction which the range refers to:\fBO\fR \- The original direction of the connection\&. .sp \fBR\fR \- The opposite direction from the original connection\&. .sp \fBB\fR \- The total of both directions\&.
.sp
If omitted,
\fBB\fR
is assumed\&.
.sp
The second letter determines what the range refers to\&.\fBB\fR \- Bytes .sp \fBP\fR \- Packets .sp \fBA\fR \- Average packet size\&.If omitted,
\fBB\fR
is assumed\&.
.RE
.PP
\fBHELPER \- \fR\fIhelper\fR
.RS 4
Names a Netfiler protocol
helper
module such as
\fBftp\fR,
\fBsip\fR,
\fBamanda\fR, etc\&. A packet will match if it was accepted by the named helper module\&. You can also append "\-" and a port number to the helper module name (e\&.g\&.,
\fBftp\-21\fR) to specify the port number that the original connection was made on\&.
.sp
Example: Mark all FTP data connections with mark 4:
.sp
.if n \{\
.RS 4
.\}
.nf
#MARK/    SOURCE    DEST      PROTO   PORT(S)    SOURCE  USER TEST LENGTH TOS CONNBYTES HELPER
#CLASSIFY                                        PORT(S)
4         ::/0      ::/0      TCP     \-          \-       \-    \-    \-      \-   \-         ftp
.fi
.if n \{\
.RE
.\}
.RE
.SH "EXAMPLE"
.PP
Example 1:
.RS 4
Mark all forwarded ICMP echo traffic with packet mark 1\&. Mark all forwarded peer to peer traffic with packet mark 4\&.
.sp
This is a little more complex than otherwise expected\&. Since the ipp2p module is unable to determine all packets in a connection are P2P packets, we mark the entire connection as P2P if any of the packets are determined to match\&.
.sp
We assume packet/connection mark 0 means unclassified\&.
.sp
.if n \{\
.RS 4
.\}
.nf
       #MARK/    SOURCE    DEST         PROTO   PORT(S)       SOURCE  USER    TEST
       #CLASSIFY                                              PORT(S)
       1         ::/0      ::/0         icmp    echo\-request
       1         ::/0      ::/0         icmp    echo\-reply
       RESTORE   ::/0      ::/0         all     \-             \-       \-       0
       CONTINUE  ::/0      ::/0         all     \-             \-       \-      !0
       4         ::/0      ::/0         ipp2p:all
       SAVE      ::/0      ::/0         all     \-             \-       \-       !0
.fi
.if n \{\
.RE
.\}
.sp
If a packet hasn\*(Aqt been classifed (packet mark is 0), copy the connection mark to the packet mark\&. If the packet mark is set, we\*(Aqre done\&. If the packet is P2P, set the packet mark to 4\&. If the packet mark has been set, save it to the connection mark\&.
.RE
.SH "FILES"
.PP
/etc/shorewall6/tcrules
.SH "SEE ALSO"
.PP
\m[blue]\fBhttp://shorewall\&.net/traffic_shaping\&.htm\fR\m[]
.PP
\m[blue]\fBhttp://shorewall\&.net/MultiISP\&.html\fR\m[]
.PP
\m[blue]\fBhttp://shorewall\&.net/PacketMarking\&.html\fR\m[]
.PP
shorewall6(8), shorewall6\-accounting(5), shorewall6\-actions(5), shorewall6\-blacklist(5), shorewall6\-ecn(5), shorewall6\-exclusion(5), shorewall6\-hosts(5), shorewall6\-interfaces(5), shorewall6\-maclist(5), shorewall6\-params(5), shorewall6\-policy(5), shorewall6\-providers(5), shorewall6\-route_rules(5), shorewall6\-routestopped(5), shorewall6\-rules(5), shorewall6\&.conf(5), shorewall6\-tcclasses(5), shorewall6\-tcdevices(5), shorewall6\-tos(5), shorewall6\-tunnels(5), shorewall6\-zones(5)
.SH "NOTES"
.IP " 1." 4
shorewall6-rules
.RS 4
\%http://www.shorewall.net/manpages6/shorewall6-rules.html
.RE
.IP " 2." 4
shorewall6.conf
.RS 4
\%http://www.shorewall.net/manpages6/shorewall6.conf.html
.RE
.IP " 3." 4
shorewall6-tcdevices
.RS 4
\%http://www.shorewall.net/manpages6/shorewall6-tcdevices.html
.RE
.IP " 4." 4
shorewall6-tcclasses
.RS 4
\%http://www.shorewall.net/manpages6/shorewall6-tcclasses.html
.RE
.IP " 5." 4
shorewall6-exclusion
.RS 4
\%http://www.shorewall.net/manpages6/shorewall6-exclusion.html
.RE
